<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ANVA â€“ TUG (Skeleton + JSON)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body { font-family: Arial, sans-serif; background:#f6f7f9; text-align:center; padding:16px; }
    h1 { color:#0b5ed7; }

    #wrap { width:100%; max-width:420px; margin:auto; }

    #stage{
      position:relative;
      width:100%;
      aspect-ratio: 9 / 16;
      border-radius:12px;
      overflow:hidden;
      background:#111;
    }

    video, canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
    }

    #tape{
      position:absolute;
      left:6%;
      right:6%;
      height:10px;
      bottom:18%;
      border-radius:8px;
      background: rgba(0,170,255,0.95);
      z-index:5;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:700;
    }

    #tape.tapped{
      background: rgba(0,220,140,0.95);
    }

    button{
      padding:10px 14px;
      border:0;
      border-radius:10px;
      background:#0b5ed7;
      color:#fff;
      font-weight:700;
      margin:6px;
    }

    button:disabled{ opacity:0.45; }

    #status{ margin-top:10px; font-size:14px; min-height:20px; }

    #badge{
      position:absolute;
      top:10px;
      left:10px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      background: rgba(255,255,255,0.2);
      color:#fff;
      z-index:6;
    }
  </style>
</head>

<body>
<div id="wrap">

  <h1>ANVA TUG</h1>

  <button id="btnStart">Start Camera</button>
  <button id="btnRecord" disabled>Record</button>
  <button id="btnStop" disabled>Stop</button>

  <div id="stage">
    <div id="badge">MODE: LIVE</div>
    <video id="video" playsinline muted></video>
    <canvas id="canvas"></canvas>
    <div id="tape">TAP BLUE TAPE</div>
  </div>

  <div id="status"></div>

</div>

<script>
const video  = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx    = canvas.getContext('2d');

const btnStart  = document.getElementById('btnStart');
const btnRecord = document.getElementById('btnRecord');
const btnStop   = document.getElementById('btnStop');
const tapeEl    = document.getElementById('tape');
const badgeEl   = document.getElementById('badge');
const statusEl  = document.getElementById('status');
const stageEl   = document.getElementById('stage');

let skeletonMode = false;
let stream = null;

let tape_y_norm = null;
let tape_y_px   = null;

let isRecording = false;
let frames = [];

let prevMidX = null;
let prevT = null;
let velocityHistory = [];

let events = {
  tape_crossings: [],
  turn: { anchor_ms:null, end_ms:null, time_ms:null }
};

/* ------------------ HELPERS ------------------ */

function setStatus(msg){ statusEl.textContent = msg; }

function resizeCanvas(){
  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
}

function computeTape(){
  const stageRect = stageEl.getBoundingClientRect();
  const tapeRect  = tapeEl.getBoundingClientRect();

  const tapeCenter = tapeRect.top + tapeRect.height/2;
  const relY = (tapeCenter - stageRect.top) / stageRect.height;

  tape_y_norm = relY;
  tape_y_px = relY * canvas.height;
}

function sign(v){
  if(Math.abs(v) < 0.3) return 0;
  return v > 0 ? 1 : -1;
}

/* ------------------ CAMERA ------------------ */

async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
  video.srcObject = stream;
  await video.play();
  resizeCanvas();
  btnRecord.disabled = false;
  setStatus("Camera ready. Tap tape.");
  requestAnimationFrame(loop);
}

/* ------------------ POSE STUB ------------------ */
/* Replace later with MoveNet */

function fakePose(){
  const t = performance.now();
  const x = 0.5 + 0.1*Math.sin(t/400);
  return {
    t_ms: t,
    keypoints:{
      left_ankle:{ x:x, y:0.75, score:0.99 },
      right_ankle:{ x:x, y:0.75, score:0.99 }
    }
  };
}

/* ------------------ TURN LOGIC ------------------ */

function processTurn(pose){

  const L = pose.keypoints.left_ankle;
  const R = pose.keypoints.right_ankle;
  if(!L || !R) return;

  const midX = ((L.x + R.x)/2) * canvas.width;

  if(prevMidX !== null){
    const dt = (pose.t_ms - prevT) / 1000;
    const v  = (midX - prevMidX) / dt;

    velocityHistory.push(v);
    if(velocityHistory.length > 12) velocityHistory.shift();

    if(events.turn.anchor_ms !== null && events.turn.end_ms === null){

      const avgV = velocityHistory.reduce((a,b)=>a+b,0) / velocityHistory.length;

      if(sign(avgV) !== sign(velocityHistory[0]) && Math.abs(pose.t_ms - events.turn.anchor_ms) > 150){
        events.turn.end_ms = pose.t_ms;
        events.turn.time_ms = events.turn.end_ms - events.turn.anchor_ms;
      }
    }
  }

  prevMidX = midX;
  prevT = pose.t_ms;
}

/* ------------------ LOOP ------------------ */

function loop(){

  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(skeletonMode){

    const pose = fakePose();

    if(isRecording){
      frames.push(pose);
      processTurn(pose);
    }

    ctx.beginPath();
    ctx.moveTo(canvas.width*0.05, tape_y_px);
    ctx.lineTo(canvas.width*0.95, tape_y_px);
    ctx.stroke();
  }

  requestAnimationFrame(loop);
}

/* ------------------ RECORDING ------------------ */

function startRecording(){

  frames = [];
  velocityHistory = [];
  prevMidX = null;

  events = { tape_crossings:[], turn:{anchor_ms:null,end_ms:null,time_ms:null} };

  isRecording = true;
  btnStop.disabled = false;
  btnRecord.disabled = true;

  setStatus("Recording...");
}

function stopRecording(){

  isRecording = false;
  btnStop.disabled = true;
  btnRecord.disabled = false;

  const turnSec = events.turn.time_ms ? (events.turn.time_ms/1000).toFixed(2) : "NO TURN";

  setStatus("Stopped | Turn: " + turnSec);

  downloadJSON({
    tape:{ tape_y_norm, tape_y_px },
    events,
    frames
  });
}

function downloadJSON(obj){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url;
  a.download = "ANVA_TUG.json";
  a.click();
}

/* ------------------ UI ------------------ */

btnStart.onclick  = startCamera;
btnRecord.onclick = startRecording;
btnStop.onclick   = stopRecording;

tapeEl.onclick = () => {
  skeletonMode = !skeletonMode;
  tapeEl.classList.toggle("tapped", skeletonMode);
  badgeEl.textContent = skeletonMode ? "MODE: SKELETON" : "MODE: LIVE";

  if(skeletonMode){
    computeTape();
    setStatus("Tape locked");
  }
};

setStatus("Press Start Camera");
</script>
</body>
</html>
