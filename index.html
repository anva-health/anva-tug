<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ANVA — Timed Up & Go (Privacy-Safe Capture)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body{
      font-family: Arial, sans-serif;
      background:#f6f7f9;
      text-align:center;
      padding:16px;
      color:#111;
    }
    h1{ color:#0b5ed7; margin: 8px 0 14px; }
    .card{
      max-width: 460px;
      margin: 0 auto;
      background: #fff;
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
    #cameraBox{
      position: relative;
      width:100%;
      margin: 12px auto 10px;
      display:none;
    }
    #canvas{
      width:100%;
      border-radius: 12px;
      background:#000;
    }
    .row{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin: 10px 0;
    }
    button{
      padding: 10px 14px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 15px;
    }
    #startBtn{ background:#0b5ed7; color:#fff; }
    #recordBtn{ background:#198754; color:#fff; }
    #stopBtn{ background:#dc3545; color:#fff; }
    button:disabled{ opacity:0.45; cursor:not-allowed; }
    .small{
      font-size: 13px;
      color:#444;
      margin-top: 6px;
      line-height: 1.35;
    }
    #status{
      margin-top:10px;
      font-weight:700;
      padding: 8px 10px;
      border-radius: 10px;
      display:inline-block;
      min-width: 280px;
    }
    .ok{ background:#e7f7ee; color:#146c43; }
    .bad{ background:#fdecec; color:#b02a37; }

    .sliderWrap{
      margin: 10px auto 0;
      text-align:left;
      max-width: 420px;
    }
    .sliderWrap label{
      display:block;
      font-size: 13px;
      color:#333;
      margin: 6px 0 6px;
      font-weight: 700;
    }
    input[type="range"]{
      width:100%;
    }
    .hint{
      font-size: 12px;
      color:#666;
      margin-top: 6px;
      text-align:left;
      max-width:420px;
      margin-left:auto;
      margin-right:auto;
    }
    .pill{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background:#eef2ff;
      color:#1e40af;
      font-size: 12px;
      font-weight: 700;
    }
  </style>
</head>

<body>
  <h1>ANVA — Timed Up & Go</h1>

  <div class="card">
    <div class="small">
      <span class="pill">Privacy-safe recording</span><br/>
      This page records the <b>masked canvas</b> (not the raw camera). The top portion is blacked out to prevent face capture.
    </div>

    <div id="cameraBox">
      <!-- Raw camera video (hidden) -->
      <video id="video" autoplay playsinline muted style="display:none;"></video>
      <!-- What user sees + what gets recorded -->
      <canvas id="canvas"></canvas>
    </div>

    <div class="row">
      <button id="startBtn">Start Camera</button>
      <button id="recordBtn" disabled>Record TUG</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>

    <div class="sliderWrap">
      <label for="maskRange">Privacy Mask Strength (Top Blackout): <span id="maskPct">40%</span></label>
      <input id="maskRange" type="range" min="25" max="60" value="40" step="1" />
      <div class="hint">
        Start at <b>40%</b>. If there’s any chance the face appears during forward lean, increase to <b>45–55%</b>.
        Keep hips + feet visible in the preview.
      </div>
    </div>

    <div id="status" class="bad">Press “Start Camera”.</div>

    <div class="small" style="margin-top:10px;">
      Tip: Do a quick rehearsal sit-to-stand with forward lean. If face could appear, raise the mask %.
    </div>
  </div>

<script>
  const startBtn  = document.getElementById("startBtn");
  const recordBtn = document.getElementById("recordBtn");
  const stopBtn   = document.getElementById("stopBtn");
  const statusEl  = document.getElementById("status");

  const video  = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx    = canvas.getContext("2d", { alpha: false });

  const maskRange = document.getElementById("maskRange");
  const maskPctEl = document.getElementById("maskPct");

  let camStream = null;
  let mediaRecorder = null;
  let chunks = [];

  // Mask fraction (top blackout). Adjustable by slider.
  let maskFrac = parseInt(maskRange.value, 10) / 100;

  function setStatus(msg, ok){
    statusEl.textContent = msg;
    statusEl.className = ok ? "ok" : "bad";
  }

  // Draw loop: renders camera -> canvas, then applies mask.
  function drawLoop(){
    if (!video.videoWidth || !video.videoHeight) {
      requestAnimationFrame(drawLoop);
      return;
    }

    // Ensure canvas matches actual video resolution (not CSS size)
    if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
      canvas.width  = video.videoWidth;
      canvas.height = video.videoHeight;
    }

    // Draw raw frame
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Apply top blackout mask
    const maskY = Math.floor(canvas.height * maskFrac);
    ctx.save();
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, canvas.width, maskY);
    ctx.restore();

    // Overlay small “privacy safe” label
    ctx.save();
    ctx.font = "16px Arial";
    ctx.fillStyle = "#00ff66";
    ctx.fillText("PRIVACY SAFE PREVIEW", 12, canvas.height - 14);
    ctx.restore();

    requestAnimationFrame(drawLoop);
  }

  // Start camera
  startBtn.onclick = async () => {
    try {
      camStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false
      });

      video.srcObject = camStream;
      await video.play();

      document.getElementById("cameraBox").style.display = "block";
      recordBtn.disabled = false;

      setStatus("Preview running. Adjust mask % so face can’t appear, while keeping hips + feet visible.", true);
      requestAnimationFrame(drawLoop);

    } catch (err) {
      console.error(err);
      setStatus("Camera error: " + err.message, false);
    }
  };

  // Slider updates
  maskRange.oninput = () => {
    const val = parseInt(maskRange.value, 10);
    maskPctEl.textContent = val + "%";
    maskFrac = val / 100;
  };

  // Record masked canvas stream
  recordBtn.onclick = () => {
    if (!camStream) {
      setStatus("Start camera first.", false);
      return;
    }

    chunks = [];

    const safeStream = canvas.captureStream(30);

    // iOS/Safari can be picky; prefer supported types
    let options = {};
    if (window.MediaRecorder && MediaRecorder.isTypeSupported("video/webm;codecs=vp8")) {
      options = { mimeType: "video/webm;codecs=vp8" };
    } else if (window.MediaRecorder && MediaRecorder.isTypeSupported("video/webm")) {
      options = { mimeType: "video/webm" };
    } // else let browser pick

    try {
      mediaRecorder = new MediaRecorder(safeStream, options);
    } catch (err) {
      console.error(err);
      setStatus("Recorder error: " + err.message, false);
      return;
    }

    mediaRecorder.ondataavailable = (e) => {
      if (e.data && e.data.size > 0) chunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
      const type = mediaRecorder.mimeType || "video/webm";
      const blob = new Blob(chunks, { type });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "TUG_privacy_safe.webm";
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
      setStatus("Saved: TUG_privacy_safe.webm (privacy-safe). Upload this to Drive for Colab.", true);
    };

    mediaRecorder.start();
    recordBtn.disabled = true;
    stopBtn.disabled = false;
    setStatus("Recording… (canvas is masked + safe). Press Stop when done.", true);
  };

  // Stop recording
  stopBtn.onclick = () => {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
    }
    stopBtn.disabled = true;
    recordBtn.disabled = false;
  };

  // Safety: stop camera when leaving page
  window.addEventListener("beforeunload", () => {
    try {
      if (camStream) camStream.getTracks().forEach(t => t.stop());
    } catch(e) {}
  });
</script>
</body>
</html>
