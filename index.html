<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ANVA – TUG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f6f7f9;
  text-align:center;
  padding:16px;
}
h1{ color:#0b5ed7; }

#stage{
  position:relative;
  width:100%;
  max-width:420px;
  aspect-ratio:9/16;
  margin:auto;
  border-radius:12px;
  overflow:hidden;
  background:#000;
}

video, canvas{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
}

#hud{
  position:absolute;
  left:10px;
  bottom:10px;
  padding:8px 10px;
  border-radius:10px;
  background:rgba(0,0,0,0.55);
  color:white;
  font-size:12px;
  text-align:left;
}

.row{
  margin-top:12px;
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
}

button{
  padding:12px 14px;
  border:0;
  border-radius:10px;
  font-weight:700;
  background:#0b5ed7;
  color:white;
}

button:disabled{ background:#9bb7e9; }

.ok{ background:#198754; }
.danger{ background:#dc3545; }
.ghost{
  background:white;
  color:#0b5ed7;
  border:2px solid #0b5ed7;
}

#status{
  margin-top:10px;
  font-size:13px;
  background:white;
  padding:10px;
  border-radius:10px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.3/dist/pose-detection.min.js"></script>
</head>

<body>

<h1>ANVA – TUG</h1>

<div id="stage">
  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>

  <div id="hud">
    <div><b>Mode:</b> <span id="hudMode">LIVE</span></div>
    <div><b>Time:</b> <span id="hudTime">00:00.0</span></div>
    <div><b>Frames:</b> <span id="hudFrames">0</span></div>
  </div>
</div>

<div class="row">
  <button id="btnCam" class="ok">Start Camera (Rear)</button>
  <button id="btnRecord" disabled>Record</button>
  <button id="btnStop" class="danger" disabled>Stop</button>
  <button id="btnReplay" class="ghost" disabled>Replay</button>
  <button id="btnDownload" class="ghost" disabled>Download JSON</button>
</div>

<div id="status">
  <b>Status:</b> <span id="stText">Idle</span>
</div>

<script>
(() => {

const MIN_SCORE = 0.35;
const TAPE_Y_NORM = 0.72;

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const btnCam = document.getElementById("btnCam");
const btnRecord = document.getElementById("btnRecord");
const btnStop = document.getElementById("btnStop");
const btnReplay = document.getElementById("btnReplay");
const btnDownload = document.getElementById("btnDownload");

const hudMode = document.getElementById("hudMode");
const hudTime = document.getElementById("hudTime");
const hudFrames = document.getElementById("hudFrames");

const stText = document.getElementById("stText");

let detector = null;
let stream = null;

let mode = "LIVE";
let recorded = [];
let recordStartMs = 0;

let replayIdx = 0;
let replayTimer = null;

function setStatus(t){ stText.textContent = t; }

function resize(){
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;
}

function nowMs(){ return performance.now(); }

function fmtTime(ms){
  const s = ms / 1000;
  const mm = Math.floor(s / 60);
  const ss = Math.floor(s % 60);
  const t = Math.floor((s - Math.floor(s)) * 10);
  return `${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}.${t}`;
}

function updateHUD(time, frames){
  hudMode.textContent = mode;
  hudTime.textContent = fmtTime(time);
  hudFrames.textContent = frames;
}

function drawTape(){
  const y = TAPE_Y_NORM * canvas.height;
  ctx.lineWidth = 4;
  ctx.strokeStyle = "rgba(0,140,255,0.95)";
  ctx.beginPath();
  ctx.moveTo(0,y);
  ctx.lineTo(canvas.width,y);
  ctx.stroke();
}

function drawSkeleton(kps){
  ctx.fillStyle = "rgba(0,255,170,0.9)";
  for (const kp of kps){
    if (kp.s < MIN_SCORE) continue;
    ctx.beginPath();
    ctx.arc(kp.x * canvas.width, kp.y * canvas.height, 4, 0, Math.PI*2);
    ctx.fill();
  }
}

async function startCamera(){
  resize();
  stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:{ ideal:"environment" }},
    audio:false
  });

  video.srcObject = stream;
  await video.play();

  detector = await poseDetection.createDetector(
    poseDetection.SupportedModels.MoveNet,
    { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING }
  );

  btnRecord.disabled = false;
  btnCam.disabled = true;

  setStatus("Live");
  loop();
}

async function loop(){
  if (!detector) return;

  resize();
  ctx.clearRect(0,0,canvas.width,canvas.height);

  drawTape();

  const poses = await detector.estimatePoses(video, { flipHorizontal:false });
  const pose = poses[0];

  if (pose && pose.keypoints){
    const kps = pose.keypoints.map(k => ({
      x: k.x / canvas.width,
      y: k.y / canvas.height,
      s: k.score
    }));

    drawSkeleton(kps);

    if (mode === "RECORDING"){
      recorded.push({ t_ms: Math.round(nowMs() - recordStartMs), kps });
      updateHUD(nowMs() - recordStartMs, recorded.length);
    }
  }

  if (mode === "LIVE") updateHUD(0, recorded.length);

  requestAnimationFrame(loop);
}

function startRecording(){
  recorded = [];
  recordStartMs = nowMs();
  mode = "RECORDING";

  btnRecord.disabled = true;
  btnStop.disabled = false;
  btnReplay.disabled = true;
  btnDownload.disabled = true;

  setStatus("Recording");
}

function stopRecording(){
  mode = "LIVE";

  btnRecord.disabled = false;
  btnStop.disabled = true;
  btnReplay.disabled = recorded.length === 0;
  btnDownload.disabled = recorded.length === 0;

  updateHUD(0, recorded.length);
  setStatus("Stopped");
}

function startReplay(){
  if (!recorded.length) return;

  mode = "REPLAY";
  replayIdx = 0;

  btnRecord.disabled = true;
  btnReplay.disabled = true;

  replayTimer = setInterval(() => {
    resize();
    ctx.clearRect(0,0,canvas.width,canvas.height);

    drawTape();

    const frame = recorded[replayIdx];
    if (!frame){
      clearInterval(replayTimer);
      mode = "LIVE";
      btnRecord.disabled = false;
      btnReplay.disabled = false;
      return;
    }

    drawSkeleton(frame.kps);
    updateHUD(frame.t_ms, replayIdx);

    replayIdx++;
  }, 1000/30);

  setStatus("Replay");
}

function downloadJSON(){
  const blob = new Blob([JSON.stringify({frames:recorded})]);
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "TUG_Keypoints.json";
  a.click();

  URL.revokeObjectURL(url);
}

btnCam.onclick = startCamera;
btnRecord.onclick = startRecording;
btnStop.onclick = stopRecording;
btnReplay.onclick = startReplay;
btnDownload.onclick = downloadJSON;

})();
</script>

</body>
</html>
